'use strict';!function(require,directRequire){const a=require('path'),b=require('react'),c=require('lodash'),d=require('./a1dd553cc059d528bb0ef56afed53968.js'),e=require('./a15851ca252a104aad8b3fd3fc114574.js'),f=require('./dd93307b3045531926d5a6645f6f3455.js'),g=require('./51a8f674caffc4c2fa2358314af90837.js'),h=require('./9a24eb4fb7a49d4dd24531943fc3c899.js'),j=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),i=require('./72653d4b93cdd7443296229431a7aa9a.js'),k=require('./99fff845d6c7bff564f99e38e435f827.js'),l=require('./6fc66cd42da3e8c155b22db441702cda.js'),m=require('./6620a0cf7dad1b400d60f0fdae40f524.js'),n=require('./3b5f8e2469c474c8d433c1c6926d8999.js'),o=require('./92320c1386e6db6a6f2556736a9bc280.js'),p=require('./ea653f45dc25181ca4f1b108175009b7.js'),q=require('./2a36cc34e5f44e62f9188b9fc0871d70.js'),r=require('classnames'),s=require('./0794878a22a26634e42df858bbaca543.js'),t=require('./ff946754202ecf377034d29daac7c8d9.js'),u=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),v=require('./common/locales/index.js'),w=require('./3bfffbe88b3d923921f851c0697974fe.js'),x=require('./71734cad2a6081d396ea668ffa405627.js'),y=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),z=require('./84b183688a46c9e2626d3e6f83365e13.js'),A=require('moment'),{resetBackgroundStatus:B}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),C=require('./949d8235c744ced2a80121e4dba34c28.js'),D='about:blank';let E;chrome.webRequest.onBeforeSendHeaders.addListener((a)=>{let{type:b,url:c}=a;if('websocket'===b&&0!==c.indexOf(`ws://127.0.0.1:${global.messageCenterPort}`)){let b=a.requestHeaders||[],c=w.getProjectAppID();if(b.push({name:'Referer',value:`https://servicewechat.com/${c}/devtools/page-frame.html`}),E){for(let a in E)b.push({name:a,value:E[a]});E=void 0}return{requestHeaders:b}}},{urls:['<all_urls>']},['blocking','requestHeaders']);class F extends b.Component{constructor(a){super(a),this.onResizeStop=(a,b,c)=>{this.props.windowActions.setDebuggerWindow({height:c})},this.syncDialogMap={},this.restartTimer=null,this.subPackageLoading={},this.taskMap={},this.session=+new Date,this.bbsLogConfig=c.cloneDeep(this.props.bbsLogConfig||[])}componentDidMount(){this._onAppServiceMessage=this.onAppServiceMessage.bind(this),d.register(this._onAppServiceMessage),this._onAppDataMessage=this.onAppDataMessage.bind(this),f.register(this._onAppDataMessage),this._onStorageMessage=this.onStorageMessage.bind(this),g.register(this._onStorageMessage),this._onDevtoolsMessage=this.onDevtoolsMessage.bind(this),h.register(this._onDevtoolsMessage),j.initHelper({setDebuggerWindow:this.props.setDebuggerWindow.bind(this)}),this.setupBBSLogWorkerListener(),this.initWebview()}componentWillUnmount(){this.devtoolsview&&this.devtoolsview.remove(),this.webview&&(this.webview.removeEventListener('newwindow',this._newwindow),this.webview.remove()),d.unRegister(this._onAppServiceMessage),f.unRegister(this._onAppDataMessage),g.unRegister(this._onStorageMessage),h.unRegister(this._onDevtoolsMessage);try{global.worker.bbsLogWorker&&(global.worker.bbsLogWorker.onmessage=null)}catch(a){i.error(a)}}componentWillReceiveProps(a){if(a.assdkCallbackInfo!=this.props.assdkCallbackInfo){let{callbackID:b,res:c}=a.assdkCallbackInfo;this.syncDialogMap[b]?(this.syncDialogMap[b].ok(JSON.stringify(c)),delete this.syncDialogMap[b]):d.invokeCallback(b,c)}(a.compileCommand!=this.props.compileCommand||a.device!=this.props.device)&&(d.ready=!1,this.restart()),a.appLaunched!=this.props.appLaunched&&a.appLaunched&&this.taskMap.appLaunched&&(this.taskMap.appLaunched.forEach((a)=>{a()}),delete this.taskMap.appLaunched),a.appRoute!=this.props.appRoute&&('ready'==a.appRoute.status?'appLaunch'==a.appRoute.openType?setTimeout(()=>{this.triggerLaunch()}):this.triggerAppRoute(a):'done'==a.appRoute.status&&this.triggerAppRouteDone(a)),a.networkType!=this.props.networkType&&d.triggerOnEvent({eventName:'onNetworkStatusChange',data:{isConnected:'none'!==a.networkType,networkType:a.networkType}}),a.storage!=this.props.storage&&g.send({command:'UPDATE_STORAGE',data:a.storage}),a.subPackageLoaded!=this.props.subPackageLoaded&&setTimeout(()=>{this.checkSubPackages()})}setupBBSLogWorkerListener(){this._bbsLogWorkerListener=(a)=>{if(a.data){if(a.data.error)return void i.error(a.data.error);try{if(a.data.ext.session!==this.session)return;const b=a.data.result.config,c=a.data.ext;j.display({command:u.DISPLAY_INFO,type:u.DISPLAY_TYPES.BBS_LOG_LINK,data:{messageLevel:c.level,message:c.message,explanation:b.explanation,link:b.link,linkType:b.linkType}})}catch(a){i.error(a)}}};try{global.worker.bbsLogWorker.onmessage=this._bbsLogWorkerListener}catch(a){i.error(a)}}triggerAppRouteDone(a){let b=a.currentWebview,c=b.pathName;const e=()=>{let e={};for(let a in b.query)e[a]=encodeURIComponent(b.query[a]);d.triggerOnEvent({eventName:'onAppRouteDone',data:{webviewId:b.id,path:c+'.html',query:e,openType:a.appRoute.openType}})};let f=y.checkIsInSubPackage(a.appConfig,c);!f||a.subPackageLoaded[f.root]?e():(!this.taskMap[f.root]&&(this.taskMap[f.root]=[]),this.taskMap[f.root].push(e))}triggerAppRoute(a){let b=a.currentWebview,c=b.pathName;const e=()=>{let e={};for(let a in b.query)e[a]=encodeURIComponent(b.query[a]);d.triggerOnEvent({eventName:'onAppRoute',data:{webviewId:b.id,path:c+'.html',query:e,openType:a.appRoute.openType}})};let f=y.checkIsInSubPackage(a.appConfig,c);!f||a.subPackageLoaded[f.root]?e():(!this.taskMap[f.root]&&(this.taskMap[f.root]=[]),this.taskMap[f.root].push(e))}triggerLaunch(){let a=this.props.currentWebview,b=a.pathName;const c=()=>{d.triggerOnEvent({eventName:'onAppRoute',data:{webviewId:a.id,path:b+'.html',query:a.query,scene:this.props.scene,openType:'appLaunch'}})};let e=y.checkIsInSubPackage(this.props.appConfig,b);e?this.props.subPackageLoaded[e.root]?c():(!this.taskMap[e.root]&&(this.taskMap[e.root]=[]),this.taskMap[e.root].push(c)):this.props.appLaunched?c():(!this.taskMap.appLaunched&&(this.taskMap.appLaunched=[]),this.taskMap.appLaunched.push(c))}initWebview(){this.devtoolsview&&(this.container.removeChild(this.devtoolsview),this.devtoolsview.remove()),this.webview&&(this.appservicecontainer.removeChild(this.webview),this.webview.remove());let a=this.devtoolsview=document.createElement('webview'),b=this.webview=document.createElement('webview');b.setUserAgentOverride(`wechatdevtools appservice port/${global.messageCenterPort}`),b.setAttribute('partition','persist:appservice'),b.setAttribute('tabIndex','-1'),b.addEventListener('exit',(a)=>{('abnormal'===a.reason||'crash'===a.reason||'killed'===a.reason)&&this.initWebview()}),b.addEventListener('consolemessage',(a)=>{if((!a.sourceId||a.sourceId.match(/http:\/\/127\.0\.0\.1:\d+\/appservice\/__dev__\//))&&!(1>a.level)){const b=a.message;if(b)try{this.bbsLogConfig&&global.worker.bbsLogWorker.postMessage({msgType:'evaluate',msgData:{message:a.message,context:{libVersion:this.props.project&&this.props.project.libVersion},ext:{session:this.session,level:a.level,message:a.message}}})}catch(a){i.error(a)}}}),this.initWebviewEvent(b);let c=`${a.getUserAgent()} appservicedevtools port/${global.messageCenterPort} proxy/${global.proxyPort}`;a.setUserAgentOverride(c),a.setAttribute('partition','persist:devtools'),a.setAttribute('style','height:100%;width:100%;position:relative;display:block;'),a.addEventListener('exit',(a)=>{('abnormal'===a.reason||'crash'===a.reason||'killed'===a.reason)&&this.initWebview()}),this.appservicecontainer.appendChild(b),this.showDevTools()}initWebviewEvent(a){a.addEventListener('dialog',(a)=>{let b=a.messageType||'',c=a.messageText;if('prompt'===b){if(a.preventDefault(),/^____sdk____/.test(c)){let b=JSON.parse(c.replace(/^____sdk____/,'')),d=b.command;'APPSERVICE_INVOKE'===d&&(this.syncDialogMap[b.data.callbackID]=a.dialog,this.props.assdkActions.exec(b.data))}}else if('alert'==b)if('DOCUMENT_READY'==c)d.ready=!0,this.props.simulatorActions.setAppLaunched(!0);else if(0==c.indexOf('SUBPACKAGE_READY_')){let a=c.replace(/^SUBPACKAGE_READY_/,'');this.props.simulatorActions.setSubPackage(a,!0)}else if(0===c.indexOf('SET_SOCKET_HEADER:'))try{let a=JSON.parse(c.replace('SET_SOCKET_HEADER:',''));E=a}catch(a){}});let b=a.request;b.onErrorOccurred.addListener((a)=>{let{type:b}=a;if('main_frame'===b&&0===a.error.indexOf('net::')&&'net::ERR_BLOCKED_BY_CLIENT'!==a.error)return void j.display({command:u.DISPLAY_ERROR,data:{code:C.APPSERVICE_NETWORK_ERROR,error:{details:a}}})},{urls:['<all_urls>']}),b.onBeforeSendHeaders.addListener((a)=>{let b=this.props.project;if(b){let b=a.url;if('main_frame'===a.type&&b.match(/\?load$/))return this.restart(),{cancel:!0};if(0!=b.indexOf(`http://127.0.0.1:${global.proxyPort}/appservice`)&&!/favicon\.ico$/.test(b)&&'none'==this.props.networkType)return j.display({command:u.DISPLAY_ERROR,data:{title:v.config.NO_NETWORK_TIPS_TITLE,error:{message:v.config.NO_NETWORK_TIPS_CONTENT.format(b)}}}),{cancel:!0};let d=a.requestHeaders||[],e=d.findIndex((a)=>{return'cookie'===a.name.toLowerCase()});d.splice(e,1);for(var c=0;c<d.length;++c)if('_Cookie'===d[c].name&&(d[c].name='Cookie'),'Referer'===d[c].name){let a=w.getProjectAppID();d[c].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}return{requestHeaders:a.requestHeaders}}},{urls:['<all_urls>']},['blocking','requestHeaders']),b.onHeadersReceived.addListener((a)=>{let{type:b}=a;if('xmlhttprequest'===b){let b=a.responseHeaders||[],c={};return b.forEach((a)=>{let{name:b,value:d}=a;c[b]||(c[b]=[]),c[b].push(d)}),b.push({name:'for-weapp-devtools',value:JSON.stringify(c)}),{responseHeaders:b}}return{}},{urls:['<all_urls>']},['blocking','responseHeaders'])}_newwindow(a){function b(a){nw.Window.open(a,{width:799,height:799})}a.preventDefault();let c=a.targetUrl;if(0!==c.indexOf(`http://127.0.0.1:${global.proxyPort}/appservice/appservice`)&&`http://127.0.0.1:${global.proxyPort}/favicon.ico`!==c&&0!==c.indexOf('ws://')&&0!==c.indexOf('wss://')&&c){if(0===c.indexOf('https://developers.weixin.qq.com'))return void this.props.BBS(c,u.IDE_SCENE.DEBUGGER);'https://developers.google.com/web/tools/chrome-devtools/'===c&&(c='https://mp.weixin.qq.com/debug/wxadoc/dev/index.html'),'https://developers.google.com/web/updates/2017/05/devtools-release-notes'===c&&(c='https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/new.html'),0==c.indexOf('wxfile://')&&(c=c.replace('wxfile://','http://wxfile.open.weixin.qq.com/')),b(c)}}hackNewWindow(a){a.addEventListener('newwindow',this._newwindow.bind(this))}showDevTools(){let a=this.devtoolsview,b=this.webview;this.container.appendChild(a),this.hackNewWindow(a);const c=()=>{a.removeEventListener('loadstop',c);const d=()=>{b.removeEventListener('loadstop',d),b.showDevTools(!0,a),this.loaded=!0,this.onWebviewLoadCommit(),this.restart()};b.addEventListener('loadstop',d),this.resetStatus(),b.src=D};a.addEventListener('loadstop',c),a.src=D}resetStatus(){this.loaded=!1,this.taskMap={},this.subPackageLoading={},this.bbsLogConfig=c.cloneDeep(this.props.bbsLogConfig||[]),B()}restart(){this.session=+new Date,clearTimeout(this.restartTimer),this.restartTimer=setTimeout(()=>{if(!this.loaded||!this.webview||!this.props.appConfig)return;j.cleanQueue(),this.props.simulatorActions.launch();let a=()=>{this.webview.removeEventListener('loadcommit',a),this.loaded=!0,d.ready=!0},b=`http://127.0.0.1:${global.proxyPort}/appservice/appservice`;this.resetStatus(),this.webview.src=b,this.webview.addEventListener('loadcommit',a),this.bbsLogConfig=c.cloneDeep(this.props.bbsLogConfig||[]);try{global.worker.bbsLogWorker.postMessage({msgType:'updateConfig',msgData:this.bbsLogConfig})}catch(a){}})}onWebviewLoadCommit(){j.initWebview(this.webview)}onDevtoolsMessage(a){if('CLICK'===a.command&&this.devtoolsview){const a=new UIEvent('click',{bubbles:!0});this.devtoolsview.dispatchEvent(a)}}onAppServiceMessage(a){let{command:b,data:c}=a;'APPSERVICE_PUBLISH'==b?d.publish(a):'APPSERVICE_INVOKE'==b?setTimeout(()=>{this.props.assdkActions.exec(c)}):'SEND_APP_DATA'==b?f.ready&&f.send({command:'SEND_APP_DATA',data:c}):'SYSTEM'==b&&this.onSystemCommand(c.api,c.data)}checkSubPackages(){for(let a in this.props.subPackageLoaded)if(!this.props.subPackageLoaded[a]&&!this.subPackageLoading[a]){this.subPackageLoading[a]=!0;let b=async()=>{let b=await x(this.props.project,a);this.webview.executeScript({code:b},()=>{})};this.props.appLaunched?b():(!this.taskMap.appLaunched&&(this.taskMap.appLaunched=[]),this.taskMap.appLaunched.push(b))}else this.taskMap[a]&&0<this.taskMap[a].length&&(this.taskMap[a].forEach((a)=>{a()}),delete this.taskMap[a])}onSystemCommand(a,b){switch(a){case'checkProxy':{try{let a=nw.App.getProxyForURL(b);d.send({command:'SYSTEM_CALLBACK',data:{api:'checkProxy',data:[{url:b,proxy:a}]}})}catch(a){}break}case'showDecryptedInfo':{d.send({command:'SYSTEM_CALLBACK',data:{api:'showDecryptedInfo',data:this.props.decryptedInfo}});break}case'showSystemInfo':{chrome.processes.getProcessInfo([],!0,(a)=>{let b=0,c='',e=[];for(let d in a){let f=a[d];f.privateMemory&&(b+=f.privateMemory);let{tasks:g,type:h}=f;'extension'===h&&(h='',g.forEach((a)=>{a.tabId||(c=a.title.replace(/.*open\.weixin\.qq\.com\//g,'').replace(/\?.*/,''),h+=`${c};`)}),h=h.replace(/网页视图：/g,'')),h=h.replace('\u7F51\u9875',''),e.push({type:h,osProcessId:f.osProcessId,privateMemory:(f.privateMemory/1024/1024).toFixed(2)})}b=b/1024/1024,d.send({command:'SYSTEM_CALLBACK',data:{api:'showSystemInfo',data:{restartInfo:{restartTimes:this.props.restartTimes,beginTime:A(global.beginTime).calendar()},memory:b,info:e}}})});break}case'openToolsLog':{nw.Shell.openItem(o.WeappLog);break}case'openVendor':{nw.Shell.openItem(o.WeappVendor);break}case'syncMessage':{q.sync();break}case'qcloudup':{(async(a={})=>{let b=await s.operate(this.props.project,a);d.send({command:'SYSTEM_CALLBACK',data:{api:'qcloudup',data:b}})})(b);break}case'build':{this.props.simulatorActions.compile({origin:u.COMPILE_ORIGIN.CONSOLE});break}case'preview':{this.props.toolbarActions.togglePreviewCode();break}case'upload':{this.props.infoActions.setUploadInfo({show:!0});break}default:}}onAppDataMessage(a){let{command:b,data:c}=a;'GET_APP_DATA'==b?(f.ready=!0,d.send({command:'GET_APP_DATA'})):'WRITE_APP_DATA'==b?d.send({command:'WRITE_APP_DATA',data:c}):'ON_PANEL_HIDE'==b&&(f.ready=!1)}onStorageMessage(a){let{command:b,data:c}=a;'EXEC_STORAGE_SDK'==b?this.props.assdkActions.exec(c):'STORAGE_PANNEL_SHOW'==b?(g.ready=!0,this.props.assdkActions.exec({api:'getStorage',args:{},callbackID:-1})):'STORAGE_PANNEL_HIDE'==b&&(g.ready=!1)}render(){let a=this.props,c={height:a.height};a.show&&!a.editorShow&&(c.flex='1');let d=r('devtools',{"ui-invisible":!a.show});return b.createElement(p,{innerRef:(a)=>this.container=a,width:'100%',height:a.height,className:d,style:c,topResizable:!0,onResizeStop:this.onResizeStop},b.createElement(k,null),b.createElement(l,null),b.createElement('div',{className:'ui-divider ui-divider-horizontal',style:{pointerEvents:'none'}}),b.createElement('div',{ref:(a)=>this.appservicecontainer=a,style:{width:0,height:0},tabIndex:-1}))}}module.exports=F}(require('lazyload'),require);