'use strict';!function(require,directRequire){function a(a){return a.replace(D,'').replace(E,'').replace(F,'')}function b(a=12){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let c='';for(let d,e=0;e<a;e++)d=Math.floor(Math.random()*b.length),c+=b.substring(d,d+1);return c}function c(){let a=s.getUserInfo(),b=a?a.openid:'unknow';return b||''}function d(a,b){let d=a.appid,e=c();if(b||!G[`${d}_${e}`]){let a=l.join(C,e,d);(b||!m.existsSync(a))&&(o.sync(l.join(a,y)),o.sync(l.join(a,z)),o.sync(l.join(a,A))),G[`${d}_${e}`]=!0}}function e(a){return D.test(a)?y:E.test(a)?z:F.test(a)?A:B}function f(a,d,e){let f=a.appid,g=c(),h=n.createHash('md5');return d=d||`${Date.now()}`,h.update(d),`${f}.${g}.${b()}${h.digest('hex')}${e}`}function g(a){let b=a.appid,d=c();return l.join(C,d,b)}function h(b,d){/^\/usr\/?$/i.test(b)||/^http:\/\/usr\/?$/i.test(b)?b='/usr/./':/^\/tmp\/?$/i.test(b)||/^http:\/\/tmp\/?$/i.test(b)?b='/tmp/./':(/^\/store\/?$/i.test(b)||/^http:\/\/store\/?$/i.test(b))&&(b='/store/./');let f=e(b);d=d||t.getCurrent();let g;if(f!==B){b=a(b);let e,h;e=d.appid||'',h=c();let i=l.join(C,h,e,f);if(i=/(\/|\\)$/.test(i)?i:i+'/',i=l.normalize(i),g=l.join(C,h,e,f,b),!g.startsWith(i))return{error:!0}}else{let a=d.miniprogramRoot,c=l.extname(b),e={".wxml":!0,".js":!0,".wxss":!0};if('mingganci'!==t.getCurrent().compileType&&'game'!==t.getCurrent().compileType&&(e['.json']=!0),!e[c]){let c;if(a?(c=l.join(d.projectpath,a),c=/(\/|\\)$/.test(c)?c:c+'/',c=l.normalize(c),g=l.join(d.projectpath,a,b)):(c=l.join(d.projectpath),c=/(\/|\\)$/.test(c)?c:c+'/',c=l.normalize(c),g=l.join(d.projectpath,b)),!g.startsWith(c))return{error:!0}}}return{error:!1,fileRealPath:g,type:f}}function i(a,b,d){let e=f(a,b,d),g=c(),h=l.join(C,g,a.appid,z,e);return m.writeFileSync(h,b),`${w}${e}`}function j(a,b,c){const d=1,e=65536;(function(a,b,c){if('string'!=typeof b)throw new Error('_dest must be a string');if('string'!=typeof a)throw new Error('_src must be a string');if('number'==typeof c&&c&&c!==d)throw Error(`EINVAL: invalid argument, copyfile -> '${b}'`)})(a,b,c);const f=c===d?'wx':'w',{size:g,mode:h}=m.statSync(a),j=m.openSync(a,'r'),k=m.openSync(b,f,h),l=g<e?g:e;let n=0;const o=g<e?0:g%e,p=0;let q=Buffer.allocUnsafe(l);for(let d=0;l+n+o<=g;d++,n=l*d)m.readSync(j,q,p,l,n),m.writeSync(k,q,p,l,n);if(o){const a=o;q=Buffer.allocUnsafe(a),m.readSync(j,q,p,a,n),m.writeSync(k,q,p,a,n)}m.closeSync(j),m.closeSync(k)}function k(a,b){let c=h(b);if(c.type!==y)return{error:!0,reason:`permission denied, open ${b}`};let d=c.fileRealPath,e=l.dirname(d),f=!1;try{let a=m.lstatSync(e);f=a.isDirectory()}catch(a){}return f?{error:!1,realDirPath:e,fileRealPath:d}:{error:!0,reason:`no such file or directory ${b}`}}const l=require('path'),m=require('fs'),n=require('crypto'),o=require('mkdir-p'),p=require('glob'),q=require('rmdir'),r=require('adm-zip'),s=require('./89ba85d67a88f7636d657c22b5d3e038.js'),t=require('./3bfffbe88b3d923921f851c0697974fe.js'),{DATA_PATH:u,USER_DATA_PATH:v,TMP_DATA_PATH:w,STORE_DATA_PATH:x}=require('./37be435102276ea9cf47609ff6535cd4.js'),y='usr',z='tmp',A='store',B='package',{WeappFileSystem:C}=require('./92320c1386e6db6a6f2556736a9bc280.js'),D=/^(http:\/)?\/usr\//,E=/^(http:\/)?\/tmp\//,F=/^(http:\/)?\/store\//;var G={};const H=(a,b=!1)=>{let c;switch(a){case y:{c=h('http://usr/./').fileRealPath;break}case z:{c=h('http://tmp/./').fileRealPath;break}case A:{c=h('http://store/./').fileRealPath;break}case B:{c=h('./').fileRealPath;break}default:return null;}return c=b&&c?/(\/|\\)$/.test(c)?c:c+'/':/(\/|\\)$/.test(c)?c.slice(0,-1):c,l.normalize(c)};var I={saveStoreFile:function(a,b){let c=a.appid,d=h(b);if(d.type===z){let a=d.fileRealPath;if(m.existsSync(a)){const b=m.lstatSync(a);if(b.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};let c=l.basename(a),d=m.readFileSync(a),e=l.join(a,'..','..',A,c);m.writeFileSync(e,d);try{m.unlinkSync(a)}catch(b){console.error('unlink file',a,'failed')}return{error:!1,savedFilePath:`${x}${c}`}}}return{error:!0,reason:'tempFilePath file not exist'}},saveUsrFile:function(a,b,d){let e=a.appid,f=c(),g=h(d,a);if(g.type!==y)return{error:!0,reason:`permission denied, open "${d}"`};let i=g.fileRealPath,j=l.dirname(i),k=!1;try{let a=m.lstatSync(j);k=a.isDirectory()}catch(a){}if(!k)return{error:!0,reason:`no such file or directory "${l.dirname(d)}"`};let n=h(b);if(!m.existsSync(n.fileRealPath))return{error:!0,reason:`no such file or directory "${b}"`};const o=m.lstatSync(n.fileRealPath);if(o.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};let p=m.readFileSync(n.fileRealPath);return m.writeFileSync(i,p),{error:!1,savedFilePath:d}},copyFileToTemp:function(a,b,c){let d=m.readFileSync(b);return i(a,d,c)},copyFileDataToTemp:i,getUsrFileList:function(a){let b=c(),d=a.appid,e=l.join(C,b,d,A),f={},g=p.sync('**/**',{statCache:f,nodir:!0,stat:!0,cwd:e}),h=0;for(let b in f)h+=f[b].size;return{error:!1,fileList:g,totalSize:h}},getSavedFileList:function(a){let b=c(),d=a.appid,e=l.join(C,b,d,A),f=0,g={},h=p.sync('**/**',{statCache:g,nodir:!0,stat:!0,cwd:e}),i=h.map((a)=>{let b=g[l.join(e,a).replace(/\\/g,'/')];return f+=b.size,{filePath:`${x}${a}`,size:b.size,createTime:parseInt(b.ctime.getTime()/1e3)}});return{error:!1,fileList:i,totalSize:f}},readFile:function(a,b,c){let d=h(b),e=d.fileRealPath;if(!m.existsSync(e))return{error:!0,reason:`${b} not found`};const f=m.lstatSync(e);if(f.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};let g=m.readFileSync(e,c);return{error:!1,fileData:g}},writeFile:function(a,b,c,d='utf8'){let e=k(a,b);if(e.error)return e;let f=e.fileRealPath;if(m.existsSync(f)){const a=m.lstatSync(f);if(a.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(a.isDirectory())return{error:!0,reason:`illegal operation on a directory, open ${b}`}}return m.writeFileSync(f,c,d),{error:!1}},mkdir:function(a,b){let c=k(a,b);if(c.error)return c;let d=c.fileRealPath;return m.existsSync(d)?{error:!0,reason:`file already exists ${b}`}:(o.sync(d),{error:!1})},rmdir:function(a,b){let d=k(a,b);if(d.error)return d;let e=d.fileRealPath,f=d.realDirPath,g=c();if(f===l.join(C,g,a.appid))return{error:!0,reason:`permission denied, open ${b}`};if(!m.existsSync(e)||!m.lstatSync(e).isDirectory())return{error:!0,reason:`no such file or directory  ${b}`};let h=m.readdirSync(e).filter(()=>{return!0});return 0===h.length?(m.rmdirSync(e),{error:!1}):{error:!0,reason:`directory not empty`}},readdir:function(a,b){let c=k(a,b+'/');if(c.error)return c;let d=c.fileRealPath;if(!m.existsSync(d))return{error:!0,reason:`no such file or directory  ${b}`};if(!m.lstatSync(d).isDirectory())return{error:!0,reason:`not a directory  ${b}`};let e=m.readdirSync(d).filter(()=>{return!0});return{error:!1,files:e}},createTmpfileName:function(a,b){return`${w}${f(a,'',b)}`},initTmpfileName:function(a,b,c){return`${w}${f(a,b,c)}`},getFileSystemDir:g,unlink:function(a,b){let c=h(b,a);if(c.type===B)return{error:!0,reason:`fail permission denied, open "${b}"`};let d=c.fileRealPath;if(!m.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};let e=m.lstatSync(d);if(e.isDirectory())return{error:!0,reason:`fail operation not permitted, unlink "${b}"`};try{m.unlinkSync(d)}catch(a){return{error:!0,reason:a.toString()}}return{error:!1}},stat:function(a,b){let c=h(b,a);if(c.type===B&&0===b.indexOf(u))return{error:!0,reason:`fail permission denied, open "${b}"`};let d=c.fileRealPath;if(!m.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};let e=m.lstatSync(d);return{error:!1,mode:e.mode,size:e.size,lastAccessedTime:parseInt(e.atimeMs/1e3),lastModifiedTime:parseInt(e.mtimeMs/1e3)}},saveBase64DataToFile:function(a,b,d){let e=a.appid,g=c(),h=f(a,b,d);return m.writeFileSync(l.join(C,g,e,z,h),b,{encoding:'base64'}),{error:!1,tempFilePath:`${w}${h}`}},clearFileSystem:function(a){let b=g(a);q(b,()=>{d(a,!0)})},unzip:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!m.existsSync(e))return{error:!0,reason:`no such file or directory, unzip "${b}"`};const f=c,g=h(c),i=g.fileRealPath;if(!i||g.type!==y)return{error:!0,reason:`permission denied, unzip "${f}"`};const j=l.dirname(i);if(!m.existsSync(j)||m.lstatSync(j).isSymbolicLink())return{error:!0,reason:`no such file or directory, unzip "${f}"`};const k=m.lstatSync(e);if(k.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};try{const a=new r(e),b=a.getEntries();for(const a of b){const b=a.entryName;if(/^\.\.(\\|\/)+/.test(b))throw new Error('illegal access');if(/(\\|\/)+\.\.(\\|\/)+/.test(b))throw new Error('illegal access');if(/(\\|\/)+\.\.$/.test(b))throw new Error('illegal access')}a.extractAllTo(i,!0)}catch(a){return{error:!0,reason:'unzip failed'}}return{error:!1}},rename:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!m.existsSync(e))return{error:!0,reason:`no such file or directory, rename "${b}"`};if(d.type===B)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const f=h(c),g=f.fileRealPath;if(!g||f.type!==y)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const i=H(y,!0),j=H(z,!0),k=H(A,!0),n=H(B,!0);if(!e.startsWith(i)&&!e.startsWith(j)&&!e.startsWith(k)&&!e.startsWith(n))return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(e===i||e===j||e===k||e===n)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(!g.startsWith(i)||i===g)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(m.lstatSync(e).isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(m.existsSync(g)&&m.lstatSync(g).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};const o=l.dirname(g);if(!m.existsSync(o)||m.lstatSync(o).isSymbolicLink())return{error:!0,reason:`no such file or directory, rename "${c}"`};try{m.renameSync(e,g)}catch(a){return{error:!0,reason:'rename failed'}}return{error:!1}},copyFile:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!m.existsSync(e))return{error:!0,reason:`no such file or directory, copyFile "${b}"`};const f=h(c),g=f.fileRealPath;if(!g||f.type!==y)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};const i=m.lstatSync(e);if(!i.isFile())return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(i.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};const k=H(y,!0);if(!g.startsWith(k)||k===g)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(m.existsSync(g)&&m.lstatSync(g).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};if(g===e)return{error:!1};if(m.existsSync(g)){try{m.unlinkSync(g)}catch(a){}try{m.rmdirSync(g)}catch(a){}}const n=l.dirname(g);if(!m.existsSync(n)||m.lstatSync(n).isSymbolicLink())return{error:!0,reason:`no such file or directory, copyFile "${c}"`};try{j(e,g)}catch(a){return{error:!0,reason:'copyFile failed'}}return{error:!1}}};Object.getOwnPropertyNames(I).forEach(function(a){const b=I[a];I[a]=function(){return d(arguments[0]),b.apply(I,arguments)}}),I.getFileRealPath=h,I.removeSavedFile=function(a){let b=h(a),c=b.fileRealPath;if(b.type===A&&m.existsSync(c)){try{m.unlinkSync(c)}catch(a){}return{error:!1}}return{error:!0,reason:'file not exist'}},I.getFileStat=function(a){let b=h(a),c=b.fileRealPath;try{let a=m.statSync(c);return{error:!1,size:a.size,createTime:parseInt(a.ctime.getTime()/1e3)}}catch(a){return{error:!0,reason:'file not found'}}},I.getFileInfo=function(a,b,c){let d=h(a);if(c&&d.type!==c)return{error:!0,reason:'file not find'};let e=d.fileRealPath;if(m.existsSync(e)){let c=m.lstatSync(e);if(c.isDirectory())return{error:!0,reason:`${a} is directory`};if(c.isSymbolicLink())return{error:!0,reason:`${a} is not a regular file`};let d=m.readFileSync(e),f='';if('md5'===b){let a=n.createHash('md5');a.update(d),f=a.digest('hex')}else if('sha1'===b){let a=n.createHash('sha1');a.update(d),f=a.digest('hex')}return{error:!1,size:c.size,digest:f}}return{error:!0,reason:'file not exist'}},I.isLocalId=function(a){return 0===a.indexOf(v+'/')||0===a.indexOf(w)||0===a.indexOf(x)},I.USR='usr',I.TMP='tmp',I.STORE='store',I.PACKAGE='package',module.exports=I}(require('lazyload'),require);