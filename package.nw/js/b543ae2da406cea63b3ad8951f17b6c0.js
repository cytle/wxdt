'use strict';!function(require,directRequire){function a(b){if(l){const c=m.get(b);if(c){if(c.heartbeatPendingCount>p)return d.info(`unresponsive client window (id: ${b}) will be disconnected`),q({id:b,projectid:c.projectid,fromAction:!0}),void m.delete(b);c.heartbeatPendingCount++,c.timeoutId=setTimeout(a.bind(this,b),o),l.postMessage({type:e.EVENT_HEARTBEAT,id:b})}}}function b(b){const{data:c}=b;switch(c.type){case e.EVENT_HEARTBEAT:{if(c.id){const a=m.get(c.id);a&&a.heartbeatPendingCount--}break}case e.EVENT_DEV_WINDOW_OPENED:{c.id&&(m.set(c.id,{[e.INIT_TIME]:+new Date,id:c.id,projectid:c.projectid,heartbeatPendingCount:0}),r(),a(c.id)),n.emit(e.EVENT_DEV_WINDOW_OPENED,c.id),n.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.id}`,c.id),n.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.projectid}`,c.projectid);break}case e.EVENT_DEV_WINDOW_CLOSE:{q(c);break}case e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE:{m.has(c.id)?c[e.CLI_PORT]?(m.get(c.id)[e.CLI_PORT]=c[e.CLI_PORT],n.emit(e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE,c.id,c.projectid,c[e.CLI_PORT]),n.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.id}`,c.id,c.projectid,c[e.CLI_PORT]),n.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.projectid}`,c.id,c.projectid,c[e.CLI_PORT])):d.info(`server.sync.js: a dev window notify the update of cli port without an cliPort argument, id: ${c.id}`):d.info(`server.sync.js: a dev window, whose id is not present in client window map, notify the update of cli port: ${c.id}`);break}}}const c=require('events'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./09060286633d09fb81fefc8ff1294dd7.js'),f=require('./84b183688a46c9e2626d3e6f83365e13.js'),g=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),j=require('./205e69607c4b60711b15f5ac95b40ce4.js'),k='darwin'===process.platform;let l;const m=new Map,n=new c,o=6000,p=10,q=(a)=>{m.has(a.id)?(a.projectid===j.getCurrentBrowsingContext()&&j.setCurrentBrowsingContext(j.getMainWindowHandle()),m.delete(a.id),d.info(`dev window with id ${a.id} closed`)):d.info(`server.sync.js: a dev window whose id is not present in client window map is closed: ${a.id}`),n.emit(e.EVENT_DEV_WINDOW_CLOSE,a.id),0===m.size&&(k?a.fromAction&&(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),global.Win.show()):a.fromAction?(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),global.Win.show()):global.contentDocument.hidden&&f.quit())},r=()=>{l&&l.postMessage({type:e.EVENT_SVR_WINDOW_CLI_PORT_UPDATE,cliPort:global.cliPort})};module.exports={init:()=>{l=new BroadcastChannel(e.BROADCAST_CHANNEL_NAME),l.onmessage=b,n.on(e.EVENT_DEV_WINDOW_OPENED,()=>{global.Win.hide()})},once:(a)=>new Promise((b)=>{n.once(a,b)}),onceWindowOpen:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),n.once(`${e.EVENT_DEV_WINDOW_OPENED}-${a}`,c)}),onceCliPortUpdate:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),n.once(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${a}`,(a,b,d)=>{c(d)})}),clientWindows:m,serverSyncEvents:n,closeDevWindow:(a)=>{return!!l&&(l.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE,id:a}),!0)},notifyCliPortUpdate:r,getClientIdByProjectId:function(a){for(const[b,c]of m)if(c&&c.projectid===a)return b;return null}}}(require('lazyload'),require);